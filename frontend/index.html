<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SARTHI - Intelligent Incident Co-Pilot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="app">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <h1 class="logo">SARTHI</h1>
            </header>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-page="chat" aria-label="Chat with SARTHI">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    Chat with SARTHI
                </a>
                <a href="#" class="nav-item" data-page="memory" aria-label="Memory Dashboard">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                    </svg>
                    Memory Dashboard
                </a>
                <a href="#" class="nav-item" data-page="agents" aria-label="Agent Management">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    Agents
                </a>
                <a href="#" class="nav-item" data-page="observability" aria-label="Observability & Explainability">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Observability
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <header class="header">
                <div class="header-content">
                    <div>
                        <h1 class="page-title" id="page-title">Chat with SARTHI</h1>
                        <p class="page-subtitle" id="page-subtitle">AI-powered collaborative incident co-pilot for enterprise support</p>
                    </div>
                    <div id="header-actions"></div>
                </div>
            </header>

            <div class="content-area">
                <div class="content-body">
                    <!-- Chat Interface -->
                    <div id="chat-page" class="page active">
                        <div class="chat-container">
                            <div id="alerts-container"></div>
                            <div class="messages-container" id="messages-container">
                                <div class="message assistant">
                                    <div class="message-header">SARTHI</div>
                                    <div class="message-content">
                                        Hello! I'm your AI-powered incident co-pilot. I can help you with:
                                        <ul style="margin-top: 8px; padding-left: 20px;">
                                            <li>Analyzing incident patterns</li>
                                            <li>Providing troubleshooting guidance</li>
                                            <li>Accessing historical knowledge</li>
                                            <li>Documenting solutions</li>
                                        </ul>
                                        <br>
                                        How can I assist you today?
                                    </div>
                                    <div class="message-meta">Just now</div>
                                </div>
                            </div>
                            <div class="chat-input-container">
                                <input
                                    type="text"
                                    id="chat-input"
                                    class="chat-input"
                                    placeholder="Ask me about incidents, errors, or system issues..."
                                    maxlength="1000"
                                    aria-label="Chat message input"
                                />
                                <button id="send-button" class="send-button" aria-label="Send message">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Memory Dashboard -->
                    <div id="memory-page" class="page">
                        <div class="dashboard-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Memory Statistics</h3>
                                </div>
                                <div class="card-content">
                                    <div id="memory-stats">
                                        <div class="loading"></div>
                                        Loading memory statistics...
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Recent Memories</h3>
                                </div>
                                <div class="card-content">
                                    <div id="memory-list">
                                        <div class="loading"></div>
                                        Loading recent memories...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agents Page -->
                    <div id="agents-page" class="page">
                        <div class="dashboard-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Available Agents</h3>
                                </div>
                                <div class="card-content">
                                    <div id="agents-list">
                                        <div class="loading"></div>
                                        Loading agents...
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Document Ingestion</h3>
                                </div>
                                <div class="card-content">
                                    <form id="ingestion-form">
                                        <div class="form-group">
                                            <label for="source-type" class="form-label">Source Type</label>
                                            <select id="source-type" class="form-input" required>
                                                <option value="text">Text Content</option>
                                                <option value="url">URL</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="source-value" class="form-label">Content/URL</label>
                                            <input
                                                type="text"
                                                id="source-value"
                                                class="form-input"
                                                placeholder="Enter text content or URL"
                                                required
                                            />
                                        </div>
                                        <div class="form-group">
                                            <label for="metadata" class="form-label">Metadata (JSON)</label>
                                            <textarea
                                                id="metadata"
                                                class="form-input form-textarea"
                                                placeholder='{"category": "incident", "priority": "high"}'
                                            ></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            Ingest Document
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Observability Page -->
                    <div id="observability-page" class="page">
                        <div class="observability-container">
                            <div class="execution-log">
                                <div class="execution-header">
                                    <h3 class="card-title">Live Execution Log</h3>
                                    <p class="page-subtitle">Real-time agent execution monitoring</p>
                                </div>
                                <div class="execution-content" id="execution-log">
                                    <div style="text-align: center; color: var(--gray-500); padding: var(--spacing-xl);">
                                        Start a conversation to see live execution events
                                    </div>
                                </div>
                            </div>
                            <div class="execution-summary">
                                <h3 class="card-title" style="margin-bottom: var(--spacing-lg);">Execution Summary</h3>
                                <div id="execution-summary">
                                    <div style="color: var(--gray-500);">
                                        No active execution
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-modal">
            <div class="loading" style="margin: 0 auto var(--spacing-lg);"></div>
            <p>Processing your request...</p>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_BASE: 'http://localhost:8000',
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000
        };

        // Application State
        const state = {
            currentPage: 'chat',
            conversationId: null,
            currentExecutionId: null,
            eventSource: null
        };

        // DOM Elements
        const elements = {
            pages: document.querySelectorAll('.page'),
            navItems: document.querySelectorAll('.nav-item'),
            pageTitle: document.getElementById('page-title'),
            pageSubtitle: document.getElementById('page-subtitle'),
            chatInput: document.getElementById('chat-input'),
            sendButton: document.getElementById('send-button'),
            messagesContainer: document.getElementById('messages-container'),
            alertsContainer: document.getElementById('alerts-container'),
            loadingOverlay: document.getElementById('loading-overlay'),
            ingestionForm: document.getElementById('ingestion-form'),
            executionLog: document.getElementById('execution-log'),
            executionSummary: document.getElementById('execution-summary')
        };

        // Utility Functions
        const utils = {
            generateId: () => 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),

            formatTimestamp: (date) => {
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                return `${days}d ago`;
            },

            sanitizeHtml: (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            showAlert: (message, type = 'info', duration = 5000) => {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `
                    <span>${utils.sanitizeHtml(message)}</span>
                    <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; cursor: pointer;">√ó</button>
                `;
                elements.alertsContainer.appendChild(alert);

                if (duration > 0) {
                    setTimeout(() => {
                        if (alert.parentElement) {
                            alert.remove();
                        }
                    }, duration);
                }
            },

            showLoading: (show = true) => {
                elements.loadingOverlay.style.display = show ? 'flex' : 'none';
            },

            setPageTitle: (title, subtitle) => {
                elements.pageTitle.textContent = title;
                elements.pageSubtitle.textContent = subtitle;
            }
        };

        // API Client
        const api = {
            async request(endpoint, options = {}) {
                const url = `${CONFIG.API_BASE}${endpoint}`;
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                };

                for (let attempt = 1; attempt <= CONFIG.MAX_RETRIES; attempt++) {
                    try {
                        const response = await fetch(url, config);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        return await response.json();
                    } catch (error) {
                        if (attempt === CONFIG.MAX_RETRIES) {
                            throw error;
                        }
                        await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * attempt));
                    }
                }
            },

            async sendChatMessage(message) {
                return this.request('/api/chat/query', {
                    method: 'POST',
                    body: JSON.stringify({
                        query: message,
                        attachments: [],
                        mode: 'chat'
                    })
                });
            },

            async getMemoryItems() {
                return this.request('/api/memory');
            },

            async getAgents() {
                return this.request('/api/agents');
            },

            async ingestDocument(sourceType, value, metadata) {
                return this.request('/api/agents/ingestion', {
                    method: 'POST',
                    body: JSON.stringify({
                        source_type: sourceType,
                        value: value,
                        metadata: metadata || {}
                    })
                });
            },

            async submitFeedback(executionId, rating, comment) {
                return this.request('/api/feedback', {
                    method: 'POST',
                    body: JSON.stringify({
                        execution_id: executionId,
                        rating: rating,
                        comment: comment
                    })
                });
            }
        };

        // UI Components
        const ui = {
            addMessage: (type, content, timestamp = new Date()) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;

                const header = type === 'user' ? 'You' : 'SARTHI';
                const formattedTime = utils.formatTimestamp(timestamp);

                messageDiv.innerHTML = `
                    <div class="message-header">${header}</div>
                    <div class="message-content">${utils.sanitizeHtml(content)}</div>
                    <div class="message-meta">${formattedTime}</div>
                `;

                elements.messagesContainer.appendChild(messageDiv);
                elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
            },

            clearMessages: () => {
                elements.messagesContainer.innerHTML = '';
            },

            updateMemoryStats: (items) => {
                const statsDiv = document.getElementById('memory-stats');
                const episodicCount = items.filter(item => item.type === 'episodic').length;
                const semanticCount = items.filter(item => item.type === 'semantic').length;

                statsDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-600);">${episodicCount}</div>
                            <div style="color: var(--gray-600);">Episodic Memories</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-600);">${semanticCount}</div>
                            <div style="color: var(--gray-600);">Semantic Memories</div>
                        </div>
                    </div>
                `;
            },

            updateMemoryList: (items) => {
                const listDiv = document.getElementById('memory-list');
                const recentItems = items.slice(0, 10);

                if (recentItems.length === 0) {
                    listDiv.innerHTML = '<p style="color: var(--gray-500);">No memories found</p>';
                    return;
                }

                const tableHtml = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Content</th>
                                <th>Source</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentItems.map(item => `
                                <tr>
                                    <td><span style="background: var(--gray-100); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${item.type}</span></td>
                                    <td>${utils.sanitizeHtml(item.content.substring(0, 100))}${item.content.length > 100 ? '...' : ''}</td>
                                    <td>${item.source || 'N/A'}</td>
                                    <td>${new Date(item.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                listDiv.innerHTML = tableHtml;
            },

            updateAgentsList: (agents) => {
                const listDiv = document.getElementById('agents-list');

                if (!agents || agents.length === 0) {
                    listDiv.innerHTML = '<p style="color: var(--gray-500);">No agents available</p>';
                    return;
                }

                const agentsHtml = agents.map(agent => `
                    <div style="padding: var(--spacing-md); border: 1px solid var(--gray-200); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                        <div style="font-weight: 600; color: var(--gray-900);">${agent.name}</div>
                        <div style="color: var(--gray-600); font-size: 0.875rem; margin-top: var(--spacing-xs);">
                            ${agent.name === 'SelfServiceAgent' ? 'Handles user queries and provides self-service support' : 'Processes and indexes documents for knowledge base'}
                        </div>
                    </div>
                `).join('');

                listDiv.innerHTML = agentsHtml;
            },

            addExecutionEvent: (event) => {
                const eventDiv = document.createElement('div');
                eventDiv.className = `execution-event ${event.event.replace('_', '-')}`;

                const timestamp = new Date().toLocaleTimeString();
                let content = '';

                switch (event.event) {
                    case 'agent_started':
                        content = `üöÄ Started ${event.agent}`;
                        break;
                    case 'tool_call':
                        content = `üîß Tool: ${event.tool} - ${event.input}`;
                        break;
                    case 'agent_completed':
                        content = `‚úÖ Completed ${event.agent}`;
                        break;
                    case 'final_response':
                        content = `üìù Final Response: ${event.answer.substring(0, 100)}...`;
                        break;
                    default:
                        content = `${event.event}: ${JSON.stringify(event)}`;
                }

                eventDiv.innerHTML = `
                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: var(--spacing-xs);">${timestamp}</div>
                    <div>${content}</div>
                `;

                elements.executionLog.appendChild(eventDiv);
                elements.executionLog.scrollTop = elements.executionLog.scrollHeight;
            },

            updateExecutionSummary: (summary) => {
                if (!summary) {
                    elements.executionSummary.innerHTML = '<div style="color: var(--gray-500);">No active execution</div>';
                    return;
                }

                const summaryHtml = `
                    <div class="summary-item">
                        <div class="summary-label">Priority</div>
                        <div class="summary-value">${summary.priority || 'Unknown'}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Agents Used</div>
                        <div class="summary-value">${(summary.agents_ran || []).join(', ') || 'None'}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Data Sources</div>
                        <div class="summary-value">${(summary.data_used || []).join(', ') || 'None'}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Decision Summary</div>
                        <div class="summary-value">${summary.decision_summary || 'No summary available'}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Recommended Action</div>
                        <div class="summary-value">${summary.mitigation || 'No recommendation'}</div>
                    </div>
                `;

                elements.executionSummary.innerHTML = summaryHtml;
            },

            clearExecutionLog: () => {
                elements.executionLog.innerHTML = '<div style="text-align: center; color: var(--gray-500); padding: var(--spacing-xl);">Start a conversation to see live execution events</div>';
            }
        };

        // Page Management
        const pageManager = {
            switchPage: (pageId) => {
                // Update navigation
                elements.navItems.forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-page="${pageId}"]`).classList.add('active');

                // Hide all pages, show only the selected one
                elements.pages.forEach(page => {
                    page.classList.remove('active');
                    page.style.display = 'none';
                });
                const activePage = document.getElementById(`${pageId}-page`);
                if (activePage) {
                    activePage.classList.add('active');
                    activePage.style.display = '';
                }

                // Update header
                state.currentPage = pageId;
                pageManager.updateHeader(pageId);

                // Load page data
                pageManager.loadPageData(pageId);
            },

            updateHeader: (pageId) => {
                const headers = {
                    chat: {
                        title: 'Chat with SARTHI',
                        subtitle: 'AI-powered collaborative incident co-pilot for enterprise support'
                    },
                    memory: {
                        title: 'Memory Dashboard',
                        subtitle: 'View and manage conversation memory and context'
                    },
                    agents: {
                        title: 'Agent Management',
                        subtitle: 'Configure and monitor AI agents and document ingestion'
                    },
                    observability: {
                        title: 'Observability & Explainability',
                        subtitle: 'Monitor system performance and agent execution in real-time'
                    }
                };

                const header = headers[pageId] || headers.chat;
                utils.setPageTitle(header.title, header.subtitle);
            },

            loadPageData: async (pageId) => {
                try {
                    switch (pageId) {
                        case 'memory':
                            const memoryData = await api.getMemoryItems();
                            const memoryItems = Array.isArray(memoryData) ? memoryData : (memoryData.items || []);
                            ui.updateMemoryStats(memoryItems);
                            ui.updateMemoryList(memoryItems);
                            break;
                        case 'agents':
                            const agentsData = await api.getAgents();
                            ui.updateAgentsList(agentsData);
                            break;
                        case 'observability':
                            ui.clearExecutionLog();
                            ui.updateExecutionSummary(null);
                            break;
                    }
                } catch (error) {
                    console.error(`Error loading ${pageId} data:`, error);
                    utils.showAlert(`Failed to load ${pageId} data`, 'error');
                }
            }
        };

        // Chat Functionality
        const chatManager = {
            async sendMessage() {
                const message = elements.chatInput.value.trim();
                if (!message) return;

                // Add user message
                ui.addMessage('user', message);

                // Clear input and disable
                elements.chatInput.value = '';
                elements.sendButton.disabled = true;

                try {
                    utils.showLoading(true);

                    // Send message to API
                    const response = await api.sendChatMessage(message);

                    // Store execution ID for observability
                    state.currentExecutionId = response.execution_id;

                    // Start SSE for live updates
                    chatManager.startLiveUpdates(response.execution_id);

                } catch (error) {
                    console.error('Chat error:', error);
                    ui.addMessage('assistant', 'Sorry, I encountered an error processing your request. Please try again.');
                    utils.showAlert('Failed to send message', 'error');
                    utils.showLoading(false);
                    elements.sendButton.disabled = false;
                }
            },

            startLiveUpdates(executionId) {
                // Close existing connection
                if (state.eventSource) {
                    state.eventSource.close();
                }

                // Track if we've added the assistant message yet
                let assistantMessageAdded = false;
                let currentResponse = '';

                // Start new SSE connection
                try {
                    state.eventSource = new EventSource(`${CONFIG.API_BASE}/api/chat/stream/${executionId}`);

                    state.eventSource.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            
                            // Handle response streaming
                            if (data.type === 'response' || data.final_response) {
                                utils.showLoading(false);
                                
                                // Add initial assistant message if not already added
                                if (!assistantMessageAdded) {
                                    ui.addMessage('assistant', '');
                                    assistantMessageAdded = true;
                                }
                                
                                // Get the latest response content
                                const responseContent = data.final_response || data.response || '';
                                if (responseContent) {
                                    currentResponse = responseContent;
                                    // Update the last assistant message with streaming content
                                    const messages = document.querySelectorAll('.message.assistant');
                                    if (messages.length > 0) {
                                        const lastMessage = messages[messages.length - 1];
                                        const contentDiv = lastMessage.querySelector('.message-content');
                                        if (contentDiv) {
                                            contentDiv.innerHTML = utils.sanitizeHtml(currentResponse);
                                        }
                                    }
                                }
                            }
                            
                            // Handle execution events
                            if (data.event) {
                                ui.addExecutionEvent(data);
                            }
                            
                            // Handle completion
                            if (data.status === 'completed' || data.type === 'completion') {
                                utils.showLoading(false);
                                elements.sendButton.disabled = false;
                                
                                // Close SSE after completion
                                setTimeout(() => {
                                    state.eventSource.close();
                                }, 500);
                            }
                        } catch (error) {
                            console.error('SSE parse error:', error);
                        }
                    };

                    state.eventSource.onerror = (error) => {
                        console.error('SSE error:', error);
                        state.eventSource.close();
                        utils.showLoading(false);
                        elements.sendButton.disabled = false;
                    };

                    state.eventSource.onopen = () => {
                        console.log('SSE connection opened for execution:', executionId);
                    };

                } catch (error) {
                    console.error('Failed to start live updates:', error);
                    utils.showLoading(false);
                    elements.sendButton.disabled = false;
                }
            }
        };

        // Form Handlers
        const formHandlers = {
            handleIngestion: async (event) => {
                event.preventDefault();

                const formData = new FormData(event.target);
                const sourceType = formData.get('source-type');
                const sourceValue = formData.get('source-value');
                const metadataText = formData.get('metadata');

                let metadata = {};
                if (metadataText) {
                    try {
                        metadata = JSON.parse(metadataText);
                    } catch (error) {
                        utils.showAlert('Invalid JSON in metadata field', 'error');
                        return;
                    }
                }

                try {
                    utils.showLoading(true);
                    const result = await api.ingestDocument(sourceType, sourceValue, metadata);

                    utils.showAlert(`Document ingested successfully! ${result.chunks_indexed || 0} chunks indexed.`, 'success');
                    event.target.reset();

                } catch (error) {
                    console.error('Ingestion error:', error);
                    utils.showAlert('Failed to ingest document', 'error');
                } finally {
                    utils.showLoading(false);
                }
            }
        };

        // Event Listeners
        const initEventListeners = () => {
            // Navigation
            elements.navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.dataset.page;
                    pageManager.switchPage(page);
                });
            });

            // Chat
            elements.sendButton.addEventListener('click', () => chatManager.sendMessage());
            elements.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    chatManager.sendMessage();
                }
            });

            // Forms
            elements.ingestionForm.addEventListener('submit', formHandlers.handleIngestion);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + K to focus chat input
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    elements.chatInput.focus();
                }
            });
        };

        // Application Initialization
        const init = () => {
            console.log('Initializing SARTHI Frontend...');

            // Hide all pages except chat-page on load
            elements.pages.forEach(page => {
                if (page.id === 'chat-page') {
                    page.classList.add('active');
                    page.style.display = '';
                } else {
                    page.classList.remove('active');
                    page.style.display = 'none';
                }
            });

            // Set up event listeners
            initEventListeners();

            // Load initial page data
            pageManager.loadPageData('chat');

            // Show welcome message
            utils.showAlert('Welcome to SARTHI! Connected to backend successfully.', 'success');

            console.log('SARTHI Frontend initialized successfully');
        };

        // Start the application
        document.addEventListener('DOMContentLoaded', init);

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            utils.showAlert('An unexpected error occurred', 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            utils.showAlert('An unexpected error occurred', 'error');
        });
    </script>
</body>
</html>